---
import Layout from '../../layouts/Layout.astro';

// Si ya tiene sesión, redirigir al dashboard
if (Astro.cookies.has('admin_session')) {
  return Astro.redirect('/admin');
}
---

<Layout title="Admin Access - Vantta">
  <div class="min-h-screen flex items-center justify-center px-4 relative z-10">
    
    <div class="w-full max-w-sm jx-surface p-8 shadow-[0_0_50px_rgba(0,0,0,0.5)] relative overflow-hidden">
      
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#ff31c9] via-[#a546ff] to-[#19f2ff]"></div>
      
      <div class="jx-leds" style="top: 15px; right: 15px;">
        <div class="jx-led m"></div>
        <div class="jx-led c"></div>
      </div>

      <div class="mb-8 text-center mt-2">
        <h1 class="text-2xl font-bold tracking-tight text-white mb-1 font-mono">SYSTEM ACCESS</h1>
        <div class="inline-flex items-center gap-2">
          <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse shadow-[0_0_8px_red]"></span>
          <span class="text-[10px] tracking-widest text-jules-secondary uppercase font-mono">Restricted Area</span>
        </div>
      </div>

      <form id="loginForm" class="space-y-5">
        <div class="space-y-1">
          <label class="jx-label ml-1">Identity</label>
          <input 
            type="text" 
            name="username" 
            placeholder="admin" 
            class="jx-input"
            autocomplete="off"
          />
        </div>
        
        <div class="space-y-1">
          <label class="jx-label ml-1">Access Key</label>
          <input 
            type="password" 
            name="password" 
            placeholder="•••••" 
            class="jx-input"
          />
        </div>

        <div id="error" class="hidden p-3 rounded bg-red-500/10 border border-red-500/20 text-red-400 text-xs text-center font-bold font-mono">
          ⛔ CREDENCIALES INVÁLIDAS
        </div>

        <button 
          type="submit" 
          class="w-full jx-btn jx-btnWhite mt-2 hover:scale-[1.02] active:scale-[0.98]"
        >
          AUTHENTICATE
        </button>
      </form>
      
      <div class="mt-8 text-center border-t border-white/5 pt-4">
        <a href="/" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 transition hover:underline">
          ← ABORTAR / VOLVER
        </a>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('loginForm');
  const errorDiv = document.getElementById('error');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    // @ts-ignore
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    try {
      const res = await fetch('/api/admin/auth', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });

      if (res.ok) {
        window.location.href = '/admin';
      } else {
        errorDiv?.classList.remove('hidden');
        // Efecto visual de error
        form.style.transform = 'translateX(-5px)';
        setTimeout(() => form.style.transform = 'translateX(5px)', 100);
        setTimeout(() => form.style.transform = 'translateX(0)', 200);
        
        // Limpiar password
        const passInput = form.querySelector('input[name="password"]') as HTMLInputElement;
        if(passInput) passInput.value = '';
        passInput?.focus();
      }
    } catch (err) {
      console.error(err);
    }
  });
</script>